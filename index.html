<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Syifa v15.8 - Fix History</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #6C5CE7; --s: #00CEC9; --a: #FF7675; --g: #FFD700; --bg: #F0F2F5; --ok: #2ecc71; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Fredoka', sans-serif; }
        body { background: var(--bg); padding: 10px; padding-bottom: 60px; }
        .container { max-width: 450px; margin: 0 auto; }
        
        /* Header & Badge */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .coin-badge { background: white; padding: 6px 12px; border-radius: 50px; border: 2px solid var(--g); font-weight: 600; color: #f39c12; font-size: 18px; display: flex; align-items: center; gap: 6px; }
        .nav-btns { display: flex; gap: 6px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 10px; border: none; cursor: pointer; background: white; box-shadow: 0 3px 0 #ddd; display: flex; align-items: center; justify-content: center; color: #555; }

        /* Progress Bar */
        .progress-container { background: white; padding: 12px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .progress-bg { background: #eee; height: 10px; border-radius: 10px; overflow: hidden; margin: 6px 0; }
        .progress-fill { background: linear-gradient(90deg, var(--s), var(--p)); width: 0%; height: 100%; transition: 1s; }

        /* Card System - Padding Kecil & Checkbox Jarak Pas */
        .card { background: white; padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border-left: 5px solid #ccc; gap: 12px; }
        .card.done { border-left-color: #f1c40f; background: #fffef0; }
        .card.reward { border-left-color: var(--g); }
        .card.history { font-size: 12px; padding: 8px 12px; border-left-width: 4px; opacity: 0.9; margin-bottom: 5px; }

        .check-box { width: 20px; height: 20px; cursor: pointer; accent-color: var(--p); flex-shrink: 0; }
        
        /* History Timeline */
        .history-item { position: relative; padding-left: 18px; }
        .history-item::before { content: ""; position: absolute; left: 4px; top: 0; bottom: -5px; width: 2px; border-left: 2px dashed #ddd; }
        .history-dot { position: absolute; left: 0; top: 12px; width: 8px; height: 8px; border-radius: 50%; z-index: 2; border: 2px solid white; }

        .btn-del { color: var(--a); background: none; border: none; font-size: 15px; cursor: pointer; padding: 4px; }
        
        /* Modals */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 1000; align-items:center; justify-content:center; backdrop-filter: blur(3px); }
        .modal.active { display: flex !important; }
        .modal-content { background: white; border-radius: 20px; padding: 20px; width: 90%; max-width: 380px; }
        .form-control { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #eee; margin-bottom: 10px; font-size: 14px; }
        .btn-main { width: 100%; padding: 10px; border-radius: 10px; border: none; font-weight: 600; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container" id="app" style="display:none;">
        <header>
            <div class="coin-badge"><i class="fas fa-coins"></i> <span id="coin-val">0</span></div>
            <div class="nav-btns">
                <button class="icon-btn" id="nav-dash" style="display:none;"><i class="fas fa-chart-bar"></i></button>
                <button class="icon-btn" id="nav-logout" style="color:var(--a)"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div class="progress-container">
            <div style="display:flex; justify-content:space-between; font-size: 13px; font-weight:600;"><span id="target-name">Target Hadiah</span><span id="target-percent">0%</span></div>
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
        </div>

        <h4 id="hi-user" style="margin-bottom:12px; color:var(--p)">Halo!</h4>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <h5>Challenge Aktif ‚ú®</h5>
                <button onclick="openM('modal-challenge')" id="adm-c" style="display:none; background:var(--p); color:white; padding:4px 10px; border-radius:8px; border:none; font-size:11px;">+ Challenge</button>
            </div>
            <div id="list-challenge"></div>
        </div>

        <div class="section" style="margin-top:15px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <h5>Pilihan Hadiah üéÅ</h5>
                <button onclick="openM('modal-hadiah')" id="adm-h" style="display:none; background:var(--g); color:white; padding:4px 10px; border-radius:8px; border:none; font-size:11px;">+ Hadiah</button>
            </div>
            <div id="list-hadiah"></div>
        </div>

        <div class="section" style="margin-top:20px">
            <h5 style="color:#888; margin-bottom:8px"><i class="fas fa-history"></i> History Aktivitas</h5>
            <div id="list-history"></div>
        </div>
    </div>

    <div class="modal" id="modal-dash">
        <div class="modal-content">
            <h4>Statistik Syifa</h4><br>
            <div id="dash-stats" style="margin-bottom:10px; font-size:13px; background:var(--p); color:white; padding:12px; border-radius:12px"></div>
            <button onclick="closeM('modal-dash')" class="btn-main" style="background:#eee; color:#666">Tutup</button>
        </div>
    </div>

    <div class="modal" id="modal-challenge">
        <div class="modal-content">
            <h5>Tambah Challenge</h5><br>
            <input type="text" id="c-nama" class="form-control" placeholder="Nama Misi (Contoh: Belajar)">
            <input type="number" id="c-val" class="form-control" placeholder="Nilai Koin">
            <button onclick="saveC()" class="btn-main" style="background:var(--p)">Simpan</button>
            <button onclick="closeM('modal-challenge')" style="width:100%; border:none; margin-top:8px; background:none; color:#aaa; font-size:11px">Batal</button>
        </div>
    </div>

    <div class="modal" id="modal-hadiah">
        <div class="modal-content">
            <h5>Tambah Hadiah</h5><br>
            <input type="text" id="h-nama" class="form-control" placeholder="Nama Hadiah">
            <input type="number" id="h-price" class="form-control" placeholder="Harga Koin">
            <button onclick="saveH()" class="btn-main" style="background:var(--g)">Simpan</button>
            <button onclick="closeM('modal-hadiah')" style="width:100%; border:none; margin-top:8px; background:none; color:#aaa; font-size:11px">Batal</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, deleteDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { projectId: "questsyifa" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let userNow = JSON.parse(sessionStorage.getItem('u_online'));

        window.openM = (id) => document.getElementById(id).classList.add('active');
        window.closeM = (id) => document.getElementById(id).classList.remove('active');

        if(userNow) {
            document.getElementById('app').style.display = 'block';
            document.getElementById('hi-user').innerText = `Halo, ${userNow.n}!`;
            if(userNow.r === 'admin') { ['nav-dash','adm-c','adm-h'].forEach(id => document.getElementById(id).style.display='flex'); }
            
            let allC = []; let allH = [];
            onSnapshot(collection(db, "challenge"), (s) => {
                allC = s.docs.map(d => ({id:d.id, ...d.data()}));
                render(allC, allH);
            });
            onSnapshot(collection(db, "hadiah"), (s) => {
                allH = s.docs.map(d => ({id:d.id, ...d.data()}));
                render(allC, allH);
            });
        }

        function render(challenges, hadiah) {
            let cHtml = ''; let hHtml = ''; let histArr = [];
            let totalKoinDidapat = 0;
            let totalChallengeBerhasil = 0;

            // 1. PROSES CHALLENGE
            challenges.forEach(c => {
                const nilai = parseInt(c.val) || 0; // Fix NaN: Paksa jadi angka 0 jika error
                
                if(c.approved === true) {
                    // Masuk History & Tambah Koin
                    totalKoinDidapat += nilai;
                    totalChallengeBerhasil++;
                    histArr.push({ t: `‚úÖ ${c.n}`, v: `+ü™ô${nilai}`, s: 'ok', ts: c.ts || 0 });
                } else {
                    // Muncul di Daftar Aktif
                    cHtml += `<div class="card ${c.done ? 'done' : ''}">
                        <input type="checkbox" class="check-box" ${c.done ? 'checked' : ''} onchange="window.updateAct('challenge','${c.id}',{done:this.checked})">
                        <div style="flex:1"><b>${c.n || 'Misi'}</b><br><small>Hadiah: ü™ô ${nilai}</small></div>
                        ${userNow.r === 'admin' && c.done ? `<button onclick="window.updateAct('challenge','${c.id}',{approved:true, ts:${Date.now()}})" class="icon-btn" style="background:var(--ok);color:white;width:auto;padding:0 8px;font-size:10px;height:28px">Valid</button>` : ''}
                        ${userNow.r === 'admin' ? `<button onclick="window.delDoc('challenge','${c.id}')" class="btn-del"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;
                }
            });

            // 2. PROSES HADIAH
            let totalKoinDipakai = 0;
            hadiah.forEach(h => {
                const harga = parseInt(h.price) || 0;
                if(h.claimed === true) {
                    totalKoinDipakai += harga;
                    histArr.push({ t: `üéÅ ${h.n}`, v: `-ü™ô${harga}`, s: 'a', ts: h.ts || 0 });
                } else {
                    hHtml += `<div class="card reward">
                        <div style="flex:1"><b>${h.n || 'Hadiah'}</b><br><small>Harga: ü™ô ${harga}</small></div>
                        ${(totalKoinDidapat - totalKoinDipakai) >= harga && userNow.r !== 'admin' ? `<button onclick="window.updateAct('hadiah','${h.id}',{claimed:true, ts:${Date.now()}})" class="icon-btn" style="background:var(--ok);color:white;width:auto;padding:0 8px;font-size:10px;height:28px">Klaim</button>` : ''}
                        ${userNow.r === 'admin' ? `<button onclick="window.delDoc('hadiah','${h.id}')" class="btn-del"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;
                }
            });

            // 3. UPDATE TAMPILAN
            const sisaKoin = totalKoinDidapat - totalKoinDipakai;
            document.getElementById('coin-val').innerText = sisaKoin;
            document.getElementById('list-challenge').innerHTML = cHtml || '<p style="text-align:center; color:#999; font-size:11px">Belum ada challenge aktif</p>';
            document.getElementById('list-hadiah').innerHTML = hHtml || '<p style="text-align:center; color:#999; font-size:11px">Belum ada hadiah</p>';
            
            // Render History (Urutkan dari yang terbaru)
            document.getElementById('list-history').innerHTML = histArr
                .sort((a,b) => b.ts - a.ts)
                .map(x => `<div class="history-item"><div class="history-dot" style="background:var(--${x.s})"></div><div class="card history" style="border-left-color:var(--${x.s})"><b>${x.t}</b> <span style="margin-left:auto; color:var(--${x.s})">${x.v}</span></div></div>`)
                .join('');

            // Dashboard Stats
            document.getElementById('nav-dash').onclick = () => {
                openM('modal-dash');
                document.getElementById('dash-stats').innerHTML = `
                    <p>üí∞ Koin Tersedia: <b>${sisaKoin}</b></p>
                    <p>‚úÖ Challenge Berhasil: <b>${totalChallengeBerhasil}</b></p>
                    <p>üéÅ Hadiah Diklaim: <b>${histArr.filter(x=>x.s==='a').length}</b></p>
                `;
            };

            // Progress Bar (Target ke hadiah pertama yang belum diklaim)
            const nextH = hadiah.find(h => !h.claimed);
            if(nextH) {
                const goal = parseInt(nextH.price) || 1;
                const p = Math.min(100, Math.floor((sisaKoin / goal) * 100));
                document.getElementById('progress-bar').style.width = p + '%';
                document.getElementById('target-percent').innerText = p + '%';
                document.getElementById('target-name').innerText = `Kejar: ${nextH.n}`;
            }
        }

        // Functions
        window.updateAct = (c, id, d) => updateDoc(doc(db, c, id), d);
        window.delDoc = (c, id) => confirm("Hapus permanen?") && deleteDoc(doc(db, c, id));
        
        window.saveC = async () => {
            const n = document.getElementById('c-nama').value;
            const v = document.getElementById('c-val').value;
            if(n && v) { await addDoc(collection(db, "challenge"), { n, val: parseInt(v), done: false, approved: false, ts: Date.now() }); closeM('modal-challenge'); }
        };
        window.saveH = async () => {
            const n = document.getElementById('h-nama').value;
            const p = document.getElementById('h-price').value;
            if(n && p) { await addDoc(collection(db, "hadiah"), { n, price: parseInt(p), claimed: false, ts: Date.now() }); closeM('modal-hadiah'); }
        };

        document.getElementById('nav-logout').onclick = () => { sessionStorage.clear(); location.reload(); };
    </script>
</body>
</html>
