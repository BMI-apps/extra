<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Syifa v18.5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --p: #6C5CE7; --s: #00CEC9; --a: #FF7675; --g: #FFD700; --bg: #F0F2F5; --ok: #2ecc71; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Fredoka', sans-serif; }
        body { background: var(--bg); padding: 10px; padding-bottom: 60px; }
        .container { max-width: 450px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .coin-badge { background: white; padding: 6px 15px; border-radius: 50px; border: 2px solid var(--g); font-weight: 600; color: #f39c12; font-size: 18px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-btns { display: flex; gap: 8px; }
        .icon-btn { width: 38px; height: 38px; border-radius: 10px; border: none; cursor: pointer; background: white; box-shadow: 0 3px 0 #ddd; display: flex; align-items: center; justify-content: center; color: #555; }
        
        .card { background: white; padding: 12px; border-radius: 15px; margin-bottom: 10px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.04); border-left: 5px solid #ccc; gap: 12px; position: relative; }
        .card.done { border-left-color: #f1c40f; background: #fffdf0; }
        .card.reward { border-left-color: var(--g); }

        /* MODAL USER COMPACT */
        .card-user { background: white; padding: 6px 12px; border-radius: 10px; margin-bottom: 6px; display: flex; align-items: center; border: 1px solid #eee; gap: 10px; cursor: pointer; }
        #db-user-list { max-height: 180px; overflow-y: auto; padding-right: 5px; margin-bottom: 12px; }
        
        /* Timeline History */
        #list-history { position: relative; padding-left: 20px; margin-left: 15px; border-left: 3px dashed #ddd; margin-top: 20px; }
        .card.history { border-left: none; margin-bottom: 15px; position: relative; padding: 12px; display: flex; align-items: center; gap: 12px; }
        .card.history::before { content: ''; position: absolute; left: -27.5px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: white; border: 3px solid #ddd; border-radius: 50%; z-index: 2; }
        .card.history.status-ok::before { border-color: var(--ok); }
        .card.history.status-a::before { border-color: var(--a); }
        
        .h-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .h-ok { background: #e8f8f5; color: var(--ok); }
        .h-a { background: #fff5f5; color: var(--a); }

        .target-tag { position: absolute; top: 0; right: 40px; background: var(--p); color: white; font-size: 9px; padding: 3px 8px; border-radius: 0 0 8px 8px; font-weight: 600; text-transform: uppercase; }
        .clickable { cursor: pointer; flex: 1; }
        .check-box { width: 24px; height: 24px; cursor: pointer; accent-color: var(--p); flex-shrink: 0; }
        .btn-del { color: var(--a); background: none; border: none; font-size: 14px; cursor: pointer; padding: 5px; opacity: 0.4; }
        
        .progress-container { background: white; padding: 15px; border-radius: 18px; margin-bottom: 20px; }
        .progress-bg { background: #eee; height: 12px; border-radius: 10px; overflow: hidden; margin: 8px 0; }
        .progress-fill { background: linear-gradient(90deg, var(--s), var(--p)); width: 0%; height: 100%; transition: 1s; }
        
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 1000; align-items:center; justify-content:center; backdrop-filter: blur(4px); }
        .modal.active { display: flex !important; }
        .modal-content { background: white; border-radius: 25px; padding: 20px; width: 90%; max-width: 380px; }
        .form-control { width: 100%; padding: 10px 12px; border-radius: 10px; border: 2px solid #eee; margin-bottom: 8px; font-size: 14px; outline: none; }
        .btn-main { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; color: white; cursor: pointer; font-size: 15px; }
    </style>
</head>
<body>

    <div class="modal active" id="modal-login">
        <div class="modal-content" style="text-align:center">
            <h2 style="color:var(--p); margin-bottom:20px">Quest Login</h2>
            <input type="text" id="login-u" class="form-control" placeholder="Nama">
            <input type="password" id="login-p" class="form-control" placeholder="Kode Keamanan">
            <button id="btn-login-exec" class="btn-main" style="background:var(--p)">Masuk</button>
        </div>
    </div>

    <div class="container" id="app" style="display:none;">
        <header>
            <div class="coin-badge"><i class="fas fa-coins"></i> <span id="coin-val">0</span></div>
            <div class="nav-btns">
                <button class="icon-btn" id="nav-user" style="display:none;"><i class="fas fa-users-cog"></i></button>
                <button class="icon-btn" id="nav-logout" style="color:var(--a)"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div class="progress-container">
            <div style="display:flex; justify-content:space-between; font-size: 14px; font-weight:600;"><span id="target-name">Target</span><span id="target-percent">0%</span></div>
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
        </div>

        <h4 id="hi-user" style="margin-bottom:15px; color:var(--p);">Halo! ‚ú®</h4>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <small style="letter-spacing: 1px; color: #888;"><b>CHALLENGE HARIAN</b></small>
                <button onclick="clearC(); openM('modal-challenge', 'c-nama')" id="adm-c" style="display:none; background:var(--p); color:white; padding:5px 12px; border-radius:8px; border:none; font-size:11px; font-weight:600;">+ Buat</button>
            </div>
            <div id="list-challenge"></div>
        </div>

        <div class="section" style="margin-top:20px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <small style="letter-spacing: 1px; color: #888;"><b>HADIAH KEREN</b></small>
                <button onclick="clearH(); openM('modal-hadiah', 'h-nama')" id="adm-h" style="display:none; background:var(--g); color:white; padding:5px 12px; border-radius:8px; border:none; font-size:11px; font-weight:600;">+ Buat</button>
            </div>
            <div id="list-hadiah"></div>
        </div>

        <div class="section" style="margin-top:30px">
            <small style="color:#aaa; letter-spacing: 1px; display:block; text-align:center;">--- Jurnal Petualangan ---</small>
            <div id="list-history"></div>
        </div>
    </div>

    <div class="modal" id="modal-user-list">
        <div class="modal-content">
            <h5 style="margin-bottom:12px; color:var(--p)">Pengaturan User</h5>
            <div id="db-user-list"></div>
            
            <input type="hidden" id="u-id">
            <input type="text" id="u-nama" class="form-control" placeholder="Nama User">
            <input type="text" id="u-pass" class="form-control" placeholder="Kode Keamanan">
            <select id="u-role" class="form-control">
                <option value="user">Peran: User</option>
                <option value="admin">Peran: Admin</option>
            </select>
            
            <div style="display:flex; gap:8px; margin-top:5px">
                <button id="btn-save-user" class="btn-main" style="background:var(--ok); flex:2">Simpan</button>
                <button id="btn-alt-user" onclick="window.handleUserAlt()" class="btn-main" style="background:var(--p); flex:1"><i class="fas fa-plus" id="alt-icon"></i></button>
            </div>
            <button onclick="closeM('modal-user-list')" style="width:100%; border:none; background:none; color:#bbb; font-size:12px; margin-top:12px; cursor:pointer">Tutup Jendela</button>
        </div>
    </div>

    <div class="modal" id="modal-challenge">
        <div class="modal-content">
            <h5 style="margin-bottom:12px">Challenge</h5>
            <input type="hidden" id="c-id">
            <input type="text" id="c-nama" class="form-control" placeholder="Nama Tugas">
            <input type="number" id="c-val" class="form-control" placeholder="Koin (val)">
            <select id="c-gift" class="form-control"><option value="">Tautkan Hadiah</option></select>
            <button id="btn-save-challenge" class="btn-main" style="background:var(--p)">Simpan Challenge</button>
            <button onclick="closeM('modal-challenge')" style="width:100%; border:none; background:none; color:#aaa; font-size:12px; margin-top:10px">Batal</button>
        </div>
    </div>

    <div class="modal" id="modal-hadiah">
        <div class="modal-content">
            <h5 style="margin-bottom:12px">Hadiah</h5>
            <input type="hidden" id="h-id">
            <input type="text" id="h-nama" class="form-control" placeholder="Nama Hadiah">
            <input type="number" id="h-price" class="form-control" placeholder="Harga Koin (price)">
            <div style="display:flex; align-items:center; gap:10px; margin:10px 0">
                <input type="checkbox" id="h-target" style="width:18px; height:18px;">
                <label for="h-target" style="font-size:14px">Set sebagai Target Utama</label>
            </div>
            <button id="btn-save-hadiah" class="btn-main" style="background:var(--g)">Simpan Hadiah</button>
            <button onclick="closeM('modal-hadiah')" style="width:100%; border:none; background:none; color:#aaa; font-size:12px; margin-top:10px">Batal</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, deleteDoc, addDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { projectId: "questsyifa" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let userNow = JSON.parse(sessionStorage.getItem('u_online'));

        window.openM = (id, fId) => { document.getElementById(id).classList.add('active'); if(fId) document.getElementById(fId).focus(); };
        window.closeM = (id) => document.getElementById(id).classList.remove('active');

        document.getElementById('btn-login-exec').onclick = async () => {
            const u = document.getElementById('login-u').value.toLowerCase().trim();
            const p = document.getElementById('login-p').value.trim();
            if(u==='papa' && p==='papa'){ sessionStorage.setItem('u_online',JSON.stringify({n:'Papa', r:'admin'})); location.reload(); return; }
            const q = await getDocs(collection(db, "users"));
            let found = false;
            q.forEach(d => { if(d.data().n.toLowerCase()===u && d.data().p===p){ sessionStorage.setItem('u_online',JSON.stringify(d.data())); location.reload(); found=true; } });
            if(!found) alert("Akses Ditolak: Nama atau Kode salah");
        };

        if(userNow) {
            document.getElementById('modal-login').classList.remove('active');
            document.getElementById('app').style.display = 'block';
            document.getElementById('hi-user').innerText = `Halo, ${userNow.n}! ‚ú®`;
            if(userNow.r === 'admin') { 
                document.getElementById('nav-user').style.display='flex';
                document.getElementById('adm-c').style.display='block';
                document.getElementById('adm-h').style.display='block';
                syncUsers();
            }
            
            let allC = []; let allH = [];
            onSnapshot(collection(db, "hadiah"), (s) => { 
                allH = s.docs.map(d => ({id:d.id, ...d.data()})); 
                let opt = '<option value="">Tautkan Hadiah</option>';
                allH.forEach(h => opt += `<option value="${h.id}">${h.n}</option>`);
                document.getElementById('c-gift').innerHTML = opt;
                refreshUI(allC, allH); 
            });
            onSnapshot(collection(db, "challenge"), (s) => { 
                allC = s.docs.map(d => ({id:d.id, ...d.data()})); 
                refreshUI(allC, allH); 
            });
        }

        function refreshUI(challenges, hadiah) {
            let cHtml = ''; let hHtml = ''; let histArr = [];
            let totalKoin = 0; let kPakai = 0;

            challenges.forEach(c => {
                const val = parseInt(c.val) || 0; 
                if(c.approved === true) {
                    totalKoin += val;
                    histArr.push({t: c.n, v: val, s:'ok', ts:c.ts||0, type:'c'});
                } else {
                    const lkd = hadiah.find(h => h.id === c.gift);
                    cHtml += `<div class="card ${c.done?'done':''}">
                        <input type="checkbox" class="check-box" ${c.done?'checked':''} onchange="window.actDoc('challenge','${c.id}',{done:this.checked})">
                        <div class="clickable" onclick="window.editC('${c.id}','${c.n}',${val},'${c.gift||''}')">
                            <b>${c.n}</b><br><small style="color:var(--p)">ü™ô ${val.toLocaleString()} ${lkd?' | üéÅ '+lkd.n:''}</small>
                        </div>
                        ${userNow.r==='admin' && c.done ? `<button onclick="window.actDoc('challenge','${c.id}',{approved:true, ts:${Date.now()}})" class="icon-btn" style="background:var(--ok);color:white;width:auto;padding:0 12px;font-size:11px;height:32px;box-shadow:none;border-radius:8px">Valid</button>`:''}
                        ${userNow.r==='admin'? `<button onclick="window.delDoc('challenge','${c.id}')" class="btn-del"><i class="fas fa-trash"></i></button>`:''}
                    </div>`;
                }
            });

            hadiah.forEach(h => {
                const prc = parseInt(h.price) || 0;
                if(h.claimed === true) {
                    kPakai += prc;
                    histArr.push({t: `${h.n}`, v: prc, s:'a', ts:h.ts||0, type:'h'});
                } else {
                    hHtml += `<div class="card reward">
                        ${h.isTarget ? '<div class="target-tag">Target</div>' : ''}
                        <div class="clickable" onclick="window.editH('${h.id}','${h.n}',${prc},${h.isTarget||false})">
                            <b>${h.n}</b><br><small style="color:#f39c12">ü™ô ${prc.toLocaleString()}</small>
                        </div>
                        ${(totalKoin-kPakai)>=prc && userNow.r!=='admin'? `<button onclick="window.actDoc('hadiah','${h.id}',{claimed:true, ts:${Date.now()}})" class="icon-btn" style="background:var(--ok);color:white;width:auto;padding:0 12px;font-size:11px;height:32px;box-shadow:none;border-radius:8px">Klaim</button>`:''}
                        ${userNow.r==='admin'? `<button onclick="window.delDoc('hadiah','${h.id}')" class="btn-del"><i class="fas fa-trash"></i></button>`:''}
                    </div>`;
                }
            });

            const net = totalKoin - kPakai;
            document.getElementById('coin-val').innerText = net.toLocaleString();
            document.getElementById('list-challenge').innerHTML = cHtml;
            document.getElementById('list-hadiah').innerHTML = hHtml;
            
            document.getElementById('list-history').innerHTML = histArr
                .sort((a,b)=>b.ts - a.ts)
                .map(x=> `
                    <div class="card history status-${x.s}">
                        <div class="h-icon ${x.s==='ok'?'h-ok':'h-a'}">
                            <i class="fas ${x.type==='c'?'fa-check':'fa-shopping-cart'}"></i>
                        </div>
                        <div style="flex:1">
                            <div style="font-size:10px; color:#aaa; margin-bottom:2px">${new Date(x.ts).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</div>
                            <b style="color:#444">${x.type==='h'?'Tukar: ':''}${x.t}</b>
                        </div>
                        <div style="text-align:right">
                            <span style="color:var(--${x.s}); font-weight:700">${x.type==='c'?'+':'-'} ü™ô${x.v.toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');

            let target = hadiah.find(h => !h.claimed && h.isTarget) || hadiah.find(h => !h.claimed);
            if(target){
                const tp = parseInt(target.price) || 1;
                const p = Math.min(100, Math.floor((net / tp) * 100));
                document.getElementById('progress-bar').style.width = p+'%';
                document.getElementById('target-percent').innerText = p+'%';
                document.getElementById('target-name').innerText = `Target: ${target.n}`;
            }
        }

        window.handleUserAlt = () => { document.getElementById('u-id').value ? window.clearU() : document.getElementById('u-nama').focus(); };
        window.clearU = () => { ['u-id','u-nama','u-pass'].forEach(i => document.getElementById(i).value = ""); document.getElementById('alt-icon').className = "fas fa-plus"; document.getElementById('btn-alt-user').style.background = "var(--p)"; };
        window.editU = (id, n, p, r) => { document.getElementById('u-id').value = id; document.getElementById('u-nama').value = n; document.getElementById('u-pass').value = p; document.getElementById('u-role').value = r; document.getElementById('alt-icon').className = "fas fa-times"; document.getElementById('btn-alt-user').style.background = "var(--a)"; };

        function syncUsers() {
            onSnapshot(collection(db, "users"), (s) => {
                let h = '';
                s.forEach(d => { 
                    const u = d.data(); 
                    h += `<div class="card-user" onclick="window.editU('${d.id}','${u.n}','${u.p}','${u.r}')">
                            <div style="flex:1; font-weight:600; color:#444">${u.n} <small style="font-weight:400; color:#999; margin-left:5px">(${u.r})</small></div>
                            <button onclick="event.stopPropagation(); window.delDoc('users','${d.id}')" class="btn-del"><i class="fas fa-trash"></i></button>
                          </div>`; 
                });
                document.getElementById('db-user-list').innerHTML = h || '<p style="font-size:12px; color:#bbb; text-align:center">Belum ada user</p>';
            });
        }

        window.actDoc = (c, id, d) => updateDoc(doc(db, c, id), d);
        window.delDoc = (c, id) => confirm("Hapus data ini?") && deleteDoc(doc(db, c, id));
        window.editC = (id, n, v, g) => { if(userNow.r==='admin') { document.getElementById('c-id').value=id; document.getElementById('c-nama').value=n; document.getElementById('c-val').value=v; document.getElementById('c-gift').value=g; window.openM('modal-challenge', 'c-nama'); } };
        window.editH = (id, n, p, isT) => { if(userNow.r==='admin') { document.getElementById('h-id').value=id; document.getElementById('h-nama').value=n; document.getElementById('h-price').value=p; document.getElementById('h-target').checked=isT; window.openM('modal-hadiah', 'h-nama'); } };
        window.clearC = () => { ['c-id','c-nama','c-val','c-gift'].forEach(i=>document.getElementById(i).value=""); };
        window.clearH = () => { ['h-id','h-nama','h-price'].forEach(i=>document.getElementById(i).value=""); document.getElementById('h-target').checked=false; };

        document.getElementById('btn-save-challenge').onclick = async () => {
            const id = document.getElementById('c-id').value;
            const d = { n: document.getElementById('c-nama').value, val: parseInt(document.getElementById('c-val').value), gift: document.getElementById('c-gift').value };
            id ? await updateDoc(doc(db, "challenge", id), d) : await addDoc(collection(db, "challenge"), {...d, done:false, approved:false, ts:Date.now()});
            closeM('modal-challenge');
        };
        document.getElementById('btn-save-hadiah').onclick = async () => {
            const id = document.getElementById('h-id').value;
            const isT = document.getElementById('h-target').checked;
            const d = { n: document.getElementById('h-nama').value, price: parseInt(document.getElementById('h-price').value), isTarget: isT };
            if(isT) {
                const batch = writeBatch(db);
                const q = await getDocs(collection(db, "hadiah"));
                q.forEach(s => { if(s.id !== id) batch.update(doc(db, "hadiah", s.id), {isTarget: false}); });
                await batch.commit();
            }
            id ? await updateDoc(doc(db, "hadiah", id), d) : await addDoc(collection(db, "hadiah"), {...d, claimed:false, ts:Date.now()});
            closeM('modal-hadiah');
        };
        document.getElementById('btn-save-user').onclick = async () => {
            const id = document.getElementById('u-id').value;
            const d = { n: document.getElementById('u-nama').value, p: document.getElementById('u-pass').value, r: document.getElementById('u-role').value };
            if(!d.n || !d.p) return alert("Nama dan Kode harus diisi!");
            id ? await updateDoc(doc(db, "users", id), d) : await addDoc(collection(db, "users"), d);
            window.clearU();
        };
        document.getElementById('nav-user').onclick = () => openM('modal-user-list', 'u-nama');
        document.getElementById('nav-logout').onclick = () => { sessionStorage.clear(); location.reload(); };
    </script>
</body>
</html>
