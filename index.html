<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Syifa v15.0 - Challenge Mode</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --p: #6C5CE7; --s: #00CEC9; --a: #FF7675; --g: #FFD700; --bg: #F0F2F5; --ok: #2ecc71; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Fredoka', sans-serif; }
        body { background: var(--bg); padding: 20px; padding-bottom: 80px; }
        .container { max-width: 500px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .coin-badge { background: white; padding: 10px 18px; border-radius: 50px; border: 2px solid var(--g); font-weight: 600; color: #f39c12; font-size: 22px; box-shadow: 0 4px 0 #eee; }
        .nav-btns { display: flex; gap: 10px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 12px; border: none; cursor: pointer; background: white; box-shadow: 0 4px 0 #ddd; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #555; }
        .progress-container { background: white; padding: 18px; border-radius: 22px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .progress-bg { background: #eee; height: 18px; border-radius: 10px; overflow: hidden; margin: 12px 0; }
        .progress-fill { background: linear-gradient(90deg, var(--s), var(--p)); width: 0%; height: 100%; transition: 1s; }
        .card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 6px solid #ccc; position: relative; }
        .card.done { border-left-color: #f1c40f; background: #fffef0; }
        .card.reward { border-left-color: var(--g); }
        .card.locked { opacity: 0.6; background: #f9f9f9; }
        .history-item { position: relative; padding-left: 25px; margin-bottom: 8px; }
        .history-item::before { content: ""; position: absolute; left: 5px; top: 0; bottom: -12px; width: 2px; border-left: 2px dashed #ddd; }
        .history-dot { position: absolute; left: 0; top: 8px; width: 12px; height: 12px; border-radius: 50%; background: #ccc; z-index: 2; border: 2px solid white; }
        .card.history { margin-bottom: 0; font-size: 13px; opacity: 0.85; border-left-width: 4px; padding: 10px 15px; border-left-color: var(--ok); }
        .btn-del { color: var(--a); background: none; border: none; font-size: 18px; margin-left: 12px; cursor: pointer; display: flex; align-items: center; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 100000; align-items:center; justify-content:center; backdrop-filter: blur(4px); }
        .modal.active { display: flex !important; }
        .modal-content { background: white; border-radius: 25px; padding: 25px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
        .form-control { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #eee; margin-bottom: 12px; font-size: 15px; outline: none; }
        .btn-main { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 600; color: white; cursor: pointer; font-size: 16px; margin-top: 5px; }
        .check-box { width: 25px; height: 25px; margin-right: 15px; cursor: pointer; accent-color: var(--p); flex-shrink: 0; }
        .handle { color: #ddd; cursor: grab; padding: 10px; margin-right: 5px; font-size: 18px; }
        .cat-chips { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .chip { padding: 8px 12px; border-radius: 10px; background: #eee; cursor: pointer; font-size: 12px; border: 2px solid transparent; transition: 0.3s; }
        .chip.active { background: var(--p); color: white; border-color: var(--p); }
        .label-small { font-size: 11px; color: #999; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>
    <div class="container" id="app" style="display:none;">
        <header>
            <div class="coin-badge"><i class="fas fa-coins"></i> <span id="coin-val">0</span></div>
            <div class="nav-btns">
                <button class="icon-btn" id="nav-user" style="display:none;"><i class="fas fa-users"></i></button>
                <button class="icon-btn" id="nav-logout" style="color:var(--a)"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div class="progress-container">
            <div style="display:flex; justify-content:space-between; font-weight:600;"><span id="target-name">Target Hadiah</span><span id="target-percent">0%</span></div>
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
            <p id="target-info" style="font-size:11px; color:#999; text-align:center"></p>
        </div>

        <h2 id="hi-user" style="margin-bottom:20px; color:var(--p)">Halo!</h2>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                <h3>Challenge Aktif ‚ú®</h3>
                <button onclick="clearFormC(); openM('modal-challenge')" id="adm-c" style="display:none; background:var(--p); color:white; padding:8px 15px; border-radius:12px; border:none; font-weight:600">+ Challenge</button>
            </div>
            <div id="list-challenge"></div>
        </div>

        <div class="section" style="margin-top:30px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                <h3>Pilihan Hadiah üéÅ</h3>
                <button onclick="clearFormH(); openM('modal-hadiah')" id="adm-h" style="display:none; background:var(--g); color:white; padding:8px 15px; border-radius:12px; border:none; font-weight:600">+ Hadiah</button>
            </div>
            <div id="list-hadiah"></div>
        </div>

        <div class="section" style="margin-top:40px">
            <h3 style="color:#888; margin-bottom:15px"><i class="fas fa-history"></i> History Selesai</h3>
            <div id="list-history"></div>
        </div>
    </div>

    <div class="modal" id="modal-challenge">
        <div class="modal-content">
            <h3>Atur Challenge</h3><br>
            <input type="hidden" id="c-id">
            <input type="text" id="c-nama" class="form-control" placeholder="Nama Challenge (misal: Tahfidz)">
            
            <label class="label-small">Tentukan Target Hadiah:</label>
            <div class="cat-chips">
                <div class="chip active" onclick="setTargetType('coin')">Langsung Koin</div>
                <div class="chip" onclick="setTargetType('time')">Durasi (Menit)</div>
            </div>
            <input type="number" id="c-val" class="form-control" placeholder="Jumlah">
            <input type="hidden" id="c-type" value="coin">

            <label class="label-small">Kategori:</label>
            <div class="cat-chips" id="cat-chips">
                <div class="chip active" onclick="setSelect('cat', 'üïå Ibadah', this)">üïå Ibadah</div>
                <div class="chip" onclick="setSelect('cat', 'üìö Belajar', this)">üìö Belajar</div>
                <div class="chip" onclick="setSelect('cat', 'üè† Mandiri', this)">üè† Mandiri</div>
            </div>
            <input type="hidden" id="c-cat" value="üïå Ibadah">
            <button id="btn-save-challenge" class="btn-main" style="background:var(--p)">Simpan Challenge</button>
            <button onclick="closeM('modal-challenge')" style="width:100%; border:none; margin-top:10px; background:none; color:#aaa">Batal</button>
        </div>
    </div>

    <div class="modal" id="modal-hadiah">
        <div class="modal-content">
            <h3>Atur Hadiah</h3><br>
            <input type="hidden" id="h-id">
            <input type="text" id="h-nama" class="form-control" placeholder="Nama Hadiah">
            <input type="number" id="h-price" class="form-control" placeholder="Harga Koin">
            
            <label class="label-small">Kunci untuk Challenge tertentu? (Opsional):</label>
            <select id="h-lock" class="form-control">
                <option value="">Semua Challenge (Umum)</option>
            </select>

            <button id="btn-save-hadiah" class="btn-main" style="background:var(--g)">Simpan Hadiah</button>
            <button onclick="closeM('modal-hadiah')" style="width:100%; border:none; margin-top:10px; background:none; color:#aaa">Batal</button>
        </div>
    </div>

    <div class="modal" id="modal-user-list">
        <div class="modal-content">
            <h3>Kelola User</h3><div id="db-user-list" style="margin:15px 0"></div><hr><br>
            <input type="hidden" id="u-id"><input type="text" id="u-nama" class="form-control" placeholder="Nama"><input type="text" id="u-pass" class="form-control" placeholder="Kode">
            <div class="cat-chips" id="role-chips">
                <div class="chip active" onclick="setSelect('role', 'user', this)">User</div>
                <div class="chip" onclick="setSelect('role', 'admin', this)">Admin</div>
            </div>
            <input type="hidden" id="u-role" value="user">
            <button id="btn-save-user" class="btn-main" style="background:var(--s)">Simpan User</button>
            <button onclick="closeM('modal-user-list')" style="width:100%; border:none; margin-top:10px; background:none; color:#aaa">Tutup</button>
        </div>
    </div>

    <div class="modal active" id="modal-login">
        <div class="modal-content">
            <h2 style="text-align:center">Quest Login</h2><br>
            <input type="text" id="login-u" class="form-control" placeholder="Nama">
            <input type="password" id="login-p" class="form-control" placeholder="Kode">
            <button id="btn-login-exec" class="btn-main" style="background:var(--p)">Masuk</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, deleteDoc, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { projectId: "questsyifa" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let userNow = JSON.parse(sessionStorage.getItem('u_online'));

        window.openM = (id) => document.getElementById(id).classList.add('active');
        window.closeM = (id) => document.getElementById(id).classList.remove('active');
        
        window.setTargetType = (t) => {
            document.getElementById('c-type').value = t;
            const chips = document.querySelectorAll('#modal-challenge .chip');
            chips[0].classList.toggle('active', t === 'coin');
            chips[1].classList.toggle('active', t === 'time');
            document.getElementById('c-val').placeholder = t === 'coin' ? "Jumlah Koin" : "Jumlah Menit";
        };

        window.setSelect = (type, val, el) => {
            el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(type === 'role' ? 'u-role' : 'c-cat').value = val;
        };

        if(userNow) {
            document.getElementById('modal-login').classList.remove('active');
            document.getElementById('app').style.display = 'block';
            document.getElementById('hi-user').innerText = `Halo, ${userNow.n}!`;
            if(userNow.r === 'admin') {
                ['nav-user','adm-c','adm-h'].forEach(id => document.getElementById(id).style.display='flex');
                syncUsers(); initSort();
            }
            let allC = []; let allH = [];
            onSnapshot(query(collection(db, "challenge"), orderBy("order", "asc")), (s) => {
                allC = s.docs.map(d => ({id:d.id, ...d.data()}));
                updateLockOptions(allC);
                render(allC, allH);
            });
            onSnapshot(query(collection(db, "hadiah"), orderBy("order", "asc")), (s) => {
                allH = s.docs.map(d => ({id:d.id, ...d.data()}));
                render(allC, allH);
            });
        }

        function updateLockOptions(challenges) {
            const select = document.getElementById('h-lock');
            let h = '<option value="">Semua Challenge (Umum)</option>';
            challenges.forEach(c => h += `<option value="${c.id}">${c.n}</option>`);
            select.innerHTML = h;
        }

        function render(challenges, hadiah) {
            let cHtml = ''; let hHtml = ''; let histHtml = '';
            let kTotal = 0; let kPakai = 0;

            // Hitung koin dari challenge yang sudah divalidasi Papa
            challenges.forEach(c => { 
                const coin = c.type === 'time' ? Math.floor(c.val/10) : c.val;
                if(c.approved) kTotal += coin; 
            });
            hadiah.forEach(h => { if(h.claimed) kPakai += h.price; });
            const net = kTotal - kPakai;

            challenges.forEach(c => {
                const coin = c.type === 'time' ? Math.floor(c.val/10) : c.val;
                const info = c.type === 'time' ? `${c.val} Min` : `${c.val} Koin`;

                if (c.approved) {
                    histHtml += `<div class="history-item"><div class="history-dot" style="background:var(--ok)"></div><div class="card history"><b>${c.cat} ${c.n}</b> &nbsp; <span style="color:var(--ok)">+ü™ô${coin}</span></div></div>`;
                } else {
                    cHtml += `<div class="card ${c.done ? 'done' : ''}" data-id="${c.id}">
                        ${userNow.r === 'admin' ? '<i class="fas fa-bars handle"></i>' : ''}
                        <input type="checkbox" class="check-box" ${c.done ? 'checked' : ''} onchange="action('challenge','${c.id}',{done:this.checked})">
                        <div style="flex:1" onclick="editC('${c.id}','${c.n}',${c.val},'${c.type}','${c.cat}')">
                            <b>${c.n}</b><br><small>${c.cat} ‚Ä¢ ü™ô${coin} (${info})</small>
                        </div>
                        ${userNow.r === 'admin' && c.done ? `<button onclick="action('challenge','${c.id}',{approved:true})" class="icon-btn" style="background:var(--ok);color:white;width:auto;padding:0 10px;font-size:12px">Validasi</button>` : ''}
                        ${userNow.r === 'admin' ? `<button onclick="del('challenge','${c.id}')" class="btn-del"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;
                }
            });

            hadiah.forEach(h => {
                if(h.claimed) {
                    histHtml += `<div class="history-item"><div class="history-dot" style="background:var(--g)"></div><div class="card history" style="border-left-color:var(--g)"><b>üéÅ ${h.n}</b> &nbsp; <span style="color:var(--a)">-ü™ô${h.price}</span></div></div>`;
                } else {
                    // Cek apakah terkunci oleh challenge tertentu
                    const lockChallenge = challenges.find(c => c.id === h.lock);
                    const isLocked = h.lock && (!lockChallenge || !lockChallenge.approved);
                    
                    hHtml += `<div class="card reward ${isLocked ? 'locked' : ''}" data-id="${h.id}">
                        ${userNow.r==='admin'?'<i class="fas fa-bars handle"></i>':''}
                        <div style="flex:1" onclick="editH('${h.id}','${h.n}',${h.price},'${h.lock||''}')">
                            <b>${h.n}</b> ${isLocked ? `<br><small style="color:var(--a)"><i class="fas fa-lock"></i> Selesaikan: ${lockChallenge ? lockChallenge.n : '?'}</small>` : ''}
                            <br><small>Harga: ü™ô${h.price}</small>
                        </div>
                        ${!isLocked && net >= h.price && userNow.r !== 'admin' ? `<button onclick="action('hadiah','${h.id}',{claimed:true})" class="icon-btn" style="background:var(--ok);color:white;width:auto;padding:0 10px;font-size:12px">Klaim</button>` : ''}
                        ${userNow.r==='admin' ? `<button onclick="del('hadiah','${h.id}')" class="btn-del"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;
                }
            });

            document.getElementById('coin-val').innerText = net;
            document.getElementById('list-challenge').innerHTML = cHtml || '<p style="text-align:center;padding:20px;color:#aaa">Belum ada challenge aktif.</p>';
            document.getElementById('list-hadiah').innerHTML = hHtml;
            document.getElementById('list-history').innerHTML = histHtml;

            const nextH = hadiah.find(h => !h.claimed && h.price > net) || hadiah.find(h => !h.claimed);
            if(nextH) {
                const p = Math.min(100, Math.floor((net / nextH.price) * 100));
                document.getElementById('progress-bar').style.width = p+'%';
                document.getElementById('target-percent').innerText = p+'%';
                document.getElementById('target-name').innerText = `Target: ${nextH.n}`;
                document.getElementById('target-info').innerText = `${net} / ${nextH.price} koin`;
            }
        }

        // --- DATABASE ACTIONS ---
        window.action = (col, id, data) => updateDoc(doc(db, col, id), data);
        window.del = (col, id) => confirm("Hapus?") && deleteDoc(doc(db, col, id));
        window.clearFormC = () => { 
            document.getElementById('c-id').value=''; document.getElementById('c-nama').value=''; 
            document.getElementById('c-val').value=''; setTargetType('coin');
        };
        window.clearFormH = () => { 
            document.getElementById('h-id').value=''; document.getElementById('h-nama').value=''; 
            document.getElementById('h-price').value=''; document.getElementById('h-lock').value='';
        };

        document.getElementById('btn-save-challenge').onclick = async () => {
            const id = document.getElementById('c-id').value;
            const d = { 
                n: document.getElementById('c-nama').value, 
                val: parseInt(document.getElementById('c-val').value), 
                type: document.getElementById('c-type').value,
                cat: document.getElementById('c-cat').value 
            };
            id ? await updateDoc(doc(db,"challenge",id), d) : await addDoc(collection(db,"challenge"), {...d, order:99, done:false, approved:false});
            closeM('modal-challenge');
        };

        document.getElementById('btn-save-hadiah').onclick = async () => {
            const id = document.getElementById('h-id').value;
            const d = { 
                n: document.getElementById('h-nama').value, 
                price: parseInt(document.getElementById('h-price').value),
                lock: document.getElementById('h-lock').value
            };
            id ? await updateDoc(doc(db,"hadiah",id), d) : await addDoc(collection(db,"hadiah"), {...d, order:99, claimed:false});
            closeM('modal-hadiah');
        };

        window.editC = (id,n,v,t,c) => { 
            if(userNow.r==='admin'){ 
                document.getElementById('c-id').value=id; document.getElementById('c-nama').value=n; 
                document.getElementById('c-val').value=v; setTargetType(t);
                document.getElementById('c-cat').value=c; openM('modal-challenge'); 
            } 
        };
        window.editH = (id,n,p,l) => { 
            if(userNow.r==='admin'){ 
                document.getElementById('h-id').value=id; document.getElementById('h-nama').value=n; 
                document.getElementById('h-price').value=p; document.getElementById('h-lock').value=l; openM('modal-hadiah'); 
            } 
        };

        // --- AUTH & USER ---
        document.getElementById('btn-login-exec').onclick = async () => {
            const u = document.getElementById('login-u').value.toLowerCase().trim();
            const p = document.getElementById('login-p').value.trim();
            if(u==='papa' && p==='papa'){ sessionStorage.setItem('u_online',JSON.stringify({n:'Papa', r:'admin'})); location.reload(); return; }
            const q = await getDocs(collection(db, "users"));
            q.forEach(d => { if(d.data().n.toLowerCase()===u && d.data().p===p){ sessionStorage.setItem('u_online',JSON.stringify(d.data())); location.reload(); } });
        };

        function syncUsers() {
            onSnapshot(collection(db, "users"), (s) => {
                let h = '';
                s.forEach(d => {
                    const u = d.data();
                    h += `<div class="card" style="padding:10px; cursor:pointer"><div style="flex:1" onclick="window.editUser('${d.id}','${u.n}','${u.p}','${u.r}')"><b>${u.n}</b> (${u.r})</div><button onclick="del('users','${d.id}')" class="btn-del"><i class="fas fa-trash"></i></button></div>`;
                });
                document.getElementById('db-user-list').innerHTML = h;
            });
        }

        window.editUser = (id, n, p, r) => {
            document.getElementById('u-id').value = id; document.getElementById('u-nama').value = n; 
            document.getElementById('u-pass').value = p; document.getElementById('u-role').value = r;
            document.querySelectorAll('#role-chips .chip').forEach(c => {
                if(c.innerText.toLowerCase() === r.toLowerCase()) c.classList.add('active');
                else c.classList.remove('active');
            });
        };

        document.getElementById('btn-save-user').onclick = async () => {
            const id = document.getElementById('u-id').value;
            const d = { n: document.getElementById('u-nama').value, p: document.getElementById('u-pass').value, r: document.getElementById('u-role').value };
            id ? await updateDoc(doc(db,"users",id), d) : await addDoc(collection(db,"users"), d);
            alert("User tersimpan!");
        };

        function initSort() {
            new Sortable(document.getElementById('list-challenge'), { handle:'.handle', animation:150, onEnd: () => saveO('challenge', 'list-challenge') });
            new Sortable(document.getElementById('list-hadiah'), { handle:'.handle', animation:150, onEnd: () => saveO('hadiah', 'list-hadiah') });
        }
        async function saveO(c, e) { document.getElementById(e).querySelectorAll('.card').forEach((item, i) => { if(item.dataset.id) updateDoc(doc(db, c, item.dataset.id), { order: i }); }); }
        document.getElementById('nav-logout').onclick = () => { sessionStorage.clear(); location.reload(); };
        document.getElementById('nav-user').onclick = () => openM('modal-user-list');
    </script>
</body>
</html>
