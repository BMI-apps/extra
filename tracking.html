<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Tracker Online - Dashboard Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #6C5CE7; --s: #00CEC9; --a: #FF7675; --g: #FFD700; --bg: #F0F2F5; --ok: #2ecc71; --wait: #f1c40f; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Fredoka', sans-serif; }
        body { background: var(--bg); padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .coin-badge { background: white; padding: 10px 15px; border-radius: 50px; border: 2px solid var(--g); font-weight: 600; color: #f39c12; box-shadow: 0 4px 0 #eee; font-size: 20px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 12px; border: none; cursor: pointer; background: white; box-shadow: 0 4px 0 #ddd; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .section-box { margin-bottom: 25px; }
        h3 { margin-bottom: 15px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        
        /* Dashboard Styles */
        .dashboard-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 15px; border-radius: 15px; text-align: center; }
        .stat-val { display: block; font-size: 22px; font-weight: 600; color: var(--p); }
        .stat-label { font-size: 12px; color: #888; }

        .card { background: white; padding: 18px; border-radius: 22px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 6px solid #eee; }
        .card.approved { border-left-color: var(--ok); }
        .card.pending { border-left-color: var(--wait); }
        .card.reward { border-left-color: var(--g); }
        .clickable { cursor: pointer; }
        
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .cat-item { padding: 10px; background: #f1f2f6; border-radius: 12px; text-align: center; cursor: pointer; font-size: 13px; border: 2px solid transparent; }
        .cat-item.selected { background: var(--p); color: white; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 35px; padding: 25px; width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
        .form-control { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #eee; background: #f9f9f9; font-size: 16px; margin-bottom: 12px; }
        .btn-main { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 600; cursor: pointer; color: white; margin-top: 5px; }
        
        #loading-ui { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--p); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 2000; }
    </style>
</head>
<body>

    <div id="loading-ui">Sinkronisasi...</div>

    <div class="modal active" id="modal-login">
        <div class="modal-content">
            <h2 style="text-align:center; margin-bottom:20px;">Quest Login üöÄ</h2>
            <form id="form-login">
                <input type="text" id="user-in" class="form-control" placeholder="Nama (Papa/Mama/Syifa)" required>
                <input type="password" id="pass-in" class="form-control" placeholder="Kode Rahasia" required>
                <button type="submit" class="btn-main" style="background:var(--p); box-shadow: 0 6px 0 #4834d4;">Masuk</button>
            </form>
        </div>
    </div>

    <div class="container" id="app" style="display:none;">
        <header>
            <div class="coin-badge"><i class="fas fa-coins"></i> <span id="coin-val">0</span></div>
            <button class="icon-btn" id="btn-logout-trigger" style="color:var(--a)"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <div class="dashboard-card">
            <h3 style="font-size: 18px;">Dashboard Minggu Ini üìä</h3>
            <canvas id="weeklyChart" style="margin-top: 15px;"></canvas>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-val" id="total-earned">0</span>
                    <span class="stat-label">Koin Didapat</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="top-cat">-</span>
                    <span class="stat-label">Fokus Utama</span>
                </div>
            </div>
        </div>

        <div class="section-box">
            <h3>Pilihan Hadiah üéÅ 
                <button class="icon-btn" id="btn-add-reward-trigger" style="display:none; width:35px; height:35px; background:var(--g); color:white;"><i class="fas fa-plus"></i></button>
            </h3>
            <div id="list-hadiah"></div>
        </div>

        <hr style="margin-bottom:25px; border: 0; border-top: 1px solid #ddd;">

        <div class="section-box">
            <h3>Misi Syifa ‚ú® 
                <button class="icon-btn" id="btn-add-misi-trigger" style="display:none; width:35px; height:35px; background:var(--a); color:white;"><i class="fas fa-plus"></i></button>
            </h3>
            <div id="list-misi"></div>
        </div>
    </div>

    <div class="modal" id="modal-misi">
        <div class="modal-content">
            <h3 id="m-title">Misi</h3><br>
            <input type="hidden" id="m-id">
            <input type="text" id="m-nama" class="form-control" placeholder="Nama Misi">
            <input type="number" id="m-durasi" class="form-control" placeholder="Durasi (Menit)">
            <div class="cat-grid" id="cat-selector">
                <div class="cat-item selected" data-cat="üìö Belajar">üìö Belajar</div>
                <div class="cat-item" data-cat="üéÆ Main">üéÆ Main</div>
                <div class="cat-item" data-cat="‚öΩ Olahraga">‚öΩ Olahraga</div>
                <div class="cat-item" data-cat="ü•ó Sehat">ü•ó Sehat</div>
            </div>
            <button id="btn-save-misi" class="btn-main" style="background:var(--p)">Simpan</button>
            <button onclick="closeM('modal-misi')" style="width:100%; background:none; border:none; margin-top:10px; color:#aaa">Batal</button>
        </div>
    </div>

    <div class="modal" id="modal-hadiah">
        <div class="modal-content">
            <h3 id="h-title">Hadiah</h3><br>
            <input type="hidden" id="h-id">
            <input type="text" id="h-nama" class="form-control" placeholder="Nama Hadiah">
            <input type="number" id="h-target" class="form-control" placeholder="Harga (Koin)">
            <button id="btn-save-hadiah" class="btn-main" style="background:var(--s)">Simpan</button>
            <button onclick="closeM('modal-hadiah')" style="width:100%; background:none; border:none; margin-top:10px; color:#aaa">Batal</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAE72y6Rg0_h7kuNR_n1777K1r0hGlwIA0",
            authDomain: "questsyifa.firebaseapp.com",
            projectId: "questsyifa",
            storageBucket: "questsyifa.firebasestorage.app",
            messagingSenderId: "361840364826",
            appId: "1:361840364826:web:2f555b73dd074e7dabf0a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const userNow = JSON.parse(sessionStorage.getItem('u_online'));
        let currentSelectedCat = "üìö Belajar";
        let myChart = null;

        const showL = (s) => document.getElementById('loading-ui').style.display = s ? 'block' : 'none';
        const openM = (id) => document.getElementById(id).classList.add('active');
        window.closeM = (id) => document.getElementById(id).classList.remove('active');

        // Login & Logout
        document.getElementById('form-login').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('user-in').value.toLowerCase();
            const p = document.getElementById('pass-in').value;
            if((u==='papa'&&p==='papa')||(u==='mama'&&p==='mama')||(u==='syifa'&&p==='syifa')){
                sessionStorage.setItem('u_online', JSON.stringify({n:u, r:(u==='syifa'?'user':'admin')}));
                location.reload();
            } else alert("Login Salah");
        };
        document.getElementById('btn-logout-trigger').onclick = () => { sessionStorage.clear(); location.reload(); };

        document.querySelectorAll('.cat-item').forEach(item => {
            item.onclick = () => {
                document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                currentSelectedCat = item.dataset.cat;
            };
        });

        if(userNow){
            document.getElementById('modal-login').classList.remove('active');
            document.getElementById('app').style.display = 'block';
            if(userNow.r === 'admin'){
                document.getElementById('btn-add-reward-trigger').style.display = 'flex';
                document.getElementById('btn-add-misi-trigger').style.display = 'flex';
            }

            onSnapshot(collection(db, "misi"), (snap) => {
                let ms = []; snap.forEach(d => ms.push({id:d.id, ...d.data()}));
                renderMisi(ms);
                updateDashboard(ms);
            });

            onSnapshot(collection(db, "hadiah"), (snap) => {
                let hd = []; snap.forEach(d => hd.push({id:d.id, ...d.data()}));
                renderHadiah(hd);
            });
        }

        function updateDashboard(ms) {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)));
            startOfWeek.setHours(0,0,0,0);

            let stats = { "üìö Belajar": 0, "üéÆ Main": 0, "‚öΩ Olahraga": 0, "ü•ó Sehat": 0 };
            let totalEarned = 0;

            ms.forEach(m => {
                if(m.approved && m.createdAt >= startOfWeek.getTime()){
                    const koin = Math.floor(m.d/10);
                    stats[m.c || "üìö Belajar"] += koin;
                    totalEarned += koin;
                }
            });

            document.getElementById('total-earned').textContent = totalEarned;
            const topCat = Object.keys(stats).reduce((a, b) => stats[a] > stats[b] ? a : b);
            document.getElementById('top-cat').textContent = stats[topCat] > 0 ? topCat.split(' ')[1] : '-';

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Belajar', 'Main', 'Olahraga', 'Sehat'],
                    datasets: [{
                        label: 'Koin Mingguan',
                        data: [stats["üìö Belajar"], stats["üéÆ Main"], stats["‚öΩ Olahraga"], stats["ü•ó Sehat"]],
                        backgroundColor: ['#6C5CE7', '#00CEC9', '#FF7675', '#2ecc71'],
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
            });
        }

        function renderMisi(ms) {
            let totalKoin = 0;
            const list = document.getElementById('list-misi');
            list.innerHTML = ms.sort((a,b)=>b.createdAt-a.createdAt).map(m => {
                if(m.approved) totalKoin += Math.floor(m.d/10);
                return `
                <div class="card ${m.approved?'approved':(m.done?'pending':'')} ${userNow.r==='admin' ? 'clickable' : ''}">
                    <input type="checkbox" style="width:25px;height:25px;margin-right:15px;" ${m.done?'checked':''} 
                        ${userNow.r==='admin'?'disabled':''} onchange="toggleMisi('${m.id}',${m.done})">
                    <div style="flex:1" onclick="prepareEditMisi('${m.id}', '${m.n}', ${m.d}, '${m.c || 'üìö Belajar'}')">
                        <div style="font-weight:600;">${m.n}</div>
                        <div style="font-size:12px;color:#aaa;">${m.c || 'üìö Belajar'} ‚Ä¢ ${m.d} Menit</div>
                    </div>
                    ${userNow.r==='admin' && m.done && !m.approved ? `<button onclick="approveMisi('${m.id}')" style="background:var(--ok);color:white;border:none;padding:5px 10px;border-radius:8px;">OK</button>` : ''}
                </div>`;
            }).join('');
            document.getElementById('coin-val').textContent = totalKoin;
        }

        function renderHadiah(hd) {
            const list = document.getElementById('list-hadiah');
            list.innerHTML = hd.map(h => `
                <div class="card reward ${userNow.r==='admin' ? 'clickable' : ''}" onclick="prepareEditReward('${h.id}', '${h.n}', ${h.t})">
                    <div style="flex:1">
                        <div style="font-weight:600;">${h.n}</div>
                        <div style="font-size:12px;color:#f39c12;"><i class="fas fa-coins"></i> ${h.t} Koin</div>
                    </div>
                </div>`).join('');
        }

        window.prepareEditMisi = (id, n, d, c) => {
            if(userNow.r !== 'admin') return;
            document.getElementById('m-id').value = id;
            document.getElementById('m-nama').value = n;
            document.getElementById('m-durasi').value = d;
            currentSelectedCat = c;
            openM('modal-misi');
        };

        window.prepareEditReward = (id, n, t) => {
            if(userNow.r !== 'admin') return;
            document.getElementById('h-id').value = id;
            document.getElementById('h-nama').value = n;
            document.getElementById('h-target').value = t;
            openM('modal-hadiah');
        };

        window.toggleMisi = async (id, st) => { await updateDoc(doc(db,"misi",id), {done:!st, approved:false}); };
        window.approveMisi = async (id) => { await updateDoc(doc(db,"misi",id), {approved:true}); };

        document.getElementById('btn-save-misi').onclick = async () => {
            const id = document.getElementById('m-id').value;
            const data = { n: document.getElementById('m-nama').value, d: parseInt(document.getElementById('m-durasi').value), c: currentSelectedCat };
            showL(true);
            id ? await updateDoc(doc(db,"misi",id), data) : await addDoc(collection(db,"misi"), {...data, done:false, approved:false, createdAt:Date.now()});
            closeM('modal-misi'); showL(false);
        };

        document.getElementById('btn-save-hadiah').onclick = async () => {
            const id = document.getElementById('h-id').value;
            const data = { n: document.getElementById('h-nama').value, t: parseInt(document.getElementById('h-target').value) };
            showL(true);
            id ? await updateDoc(doc(db,"hadiah",id), data) : await addDoc(collection(db,"hadiah"), {...data, createdAt:Date.now()});
            closeM('modal-hadiah'); showL(false);
        };
    </script>
</body>
</html>
