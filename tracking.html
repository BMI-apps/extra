<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Tracker Syifa - User Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --p: #6C5CE7; --s: #00CEC9; --a: #FF7675; --g: #FFD700; --bg: #F0F2F5; --ok: #2ecc71; --wait: #f1c40f; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Fredoka', sans-serif; }
        body { background: var(--bg); padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .coin-badge { background: white; padding: 10px 15px; border-radius: 50px; border: 2px solid var(--g); font-weight: 600; color: #f39c12; box-shadow: 0 4px 0 #eee; font-size: 20px; }
        .nav-btns { display: flex; gap: 8px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 12px; border: none; cursor: pointer; background: white; box-shadow: 0 4px 0 #ddd; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-plus { width: 35px; height: 35px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; box-shadow: 0 3px 0 rgba(0,0,0,0.1); }
        .card { background: white; padding: 18px; border-radius: 22px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 6px solid #eee; }
        .card.approved { border-left-color: var(--ok); }
        .card.reward { border-left-color: var(--g); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 30px; padding: 25px; width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
        .form-control { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #eee; margin-bottom: 12px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 600; cursor: pointer; color: white; }
    </style>
</head>
<body>

    <div class="container" id="app" style="display:none;">
        <header>
            <div class="coin-badge"><i class="fas fa-coins"></i> <span id="coin-val">0</span></div>
            <div class="nav-btns">
                <button class="icon-btn" id="btn-user-trigger" style="display:none; color:var(--s)"><i class="fas fa-users-cog"></i></button>
                <button class="icon-btn" id="btn-dash-trigger" style="display:none; color:var(--p)"><i class="fas fa-chart-bar"></i></button>
                <button class="icon-btn" id="btn-logout-trigger" style="color:var(--a)"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <h1 id="hi-user" style="margin-bottom:25px; color:var(--p)">Halo!</h1>

        <div class="section-box" style="margin-bottom: 30px;">
            <div class="section-header">
                <h3>Misi Syifa ‚ú®</h3>
                <button class="btn-plus" id="btn-add-misi-trigger" style="display:none; background:var(--a);"><i class="fas fa-plus"></i></button>
            </div>
            <div id="list-misi"></div>
        </div>

        <div class="section-box">
            <div class="section-header">
                <h3>Pilihan Hadiah üéÅ</h3>
                <button class="btn-plus" id="btn-add-reward-trigger" style="display:none; background:var(--g);"><i class="fas fa-plus"></i></button>
            </div>
            <div id="list-hadiah"></div>
        </div>
    </div>

    <div class="modal" id="modal-user-list">
        <div class="modal-content">
            <div class="section-header">
                <h3>Daftar User</h3>
                <button class="btn-plus" onclick="resetUserForm()" style="background:var(--s)"><i class="fas fa-user-plus"></i></button>
            </div>
            <div id="list-user-db" style="margin-top:15px"></div>
            <button onclick="closeM('modal-user-list')" class="btn-main" style="background:#eee; color:#666; margin-top:15px">Tutup</button>
        </div>
    </div>

    <div class="modal" id="modal-user-form">
        <div class="modal-content">
            <h3 id="u-title-text">Tambah User</h3><br>
            <input type="hidden" id="u-id">
            <input type="text" id="u-nama" class="form-control" placeholder="Nama (Contoh: syifa)">
            <input type="password" id="u-pass" class="form-control" placeholder="Kode / Password">
            <select id="u-role" class="form-control">
                <option value="user">User (Syifa)</option>
                <option value="admin">Admin (Papa/Mama)</option>
            </select>
            <button id="btn-save-user" class="btn-main" style="background:var(--s)">Simpan User</button>
            <button onclick="closeM('modal-user-form')" style="width:100%; border:none; background:none; margin-top:10px; color:#aaa">Batal</button>
        </div>
    </div>

    <div class="modal" id="modal-dash"><div class="modal-content"><h3 style="text-align:center">Statistik Quest üìä</h3><div style="margin:20px 0;"><canvas id="weeklyChart"></canvas></div><button onclick="closeM('modal-dash')" class="btn-main" style="background:#eee; color:#666;">Tutup</button></div></div>
    <div class="modal" id="modal-misi"><div class="modal-content"><h3 id="m-title-text">Misi</h3><br><input type="hidden" id="m-id"><input type="text" id="m-nama" class="form-control" placeholder="Nama Misi"><input type="number" id="m-durasi" class="form-control" placeholder="Menit"><button id="btn-save-misi" class="btn-main" style="background:var(--p)">Simpan</button><button onclick="closeM('modal-misi')" style="margin-top:10px; border:none; background:none; width:100%">Batal</button></div></div>
    <div class="modal active" id="modal-login"><div class="modal-content"><h2 style="text-align:center; margin-bottom:20px;">Quest Login üöÄ</h2><form id="form-login"><input type="text" id="user-in" class="form-control" placeholder="Nama" required><input type="password" id="pass-in" class="form-control" placeholder="Kode" required><button type="submit" class="btn-main" style="background:var(--p)">Masuk</button></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc, deleteDoc, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAE72y6Rg0_h7kuNR_n1777K1r0hGlwIA0", authDomain: "questsyifa.firebaseapp.com", projectId: "questsyifa", storageBucket: "questsyifa.firebasestorage.app", messagingSenderId: "361840364826", appId: "1:361840364826:web:2f555b73dd074e7dabf0a3" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const userNow = JSON.parse(sessionStorage.getItem('u_online'));

        window.closeM = (id) => document.getElementById(id).classList.remove('active');
        const openM = (id) => document.getElementById(id).classList.add('active');

        if(userNow){
            document.getElementById('modal-login').classList.remove('active');
            document.getElementById('app').style.display = 'block';
            document.getElementById('hi-user').textContent = `Halo, ${userNow.n}!`;
            
            if(userNow.r === 'admin') {
                document.getElementById('btn-dash-trigger').style.display = 'flex';
                document.getElementById('btn-user-trigger').style.display = 'flex';
                document.getElementById('btn-add-misi-trigger').style.display = 'flex';
                document.getElementById('btn-add-reward-trigger').style.display = 'flex';
                
                // Load User List for Admin
                onSnapshot(collection(db, "users"), (snap) => {
                    let html = '';
                    snap.forEach(d => {
                        const u = d.data();
                        html += `<div class="card" style="padding:10px 15px">
                            <div style="flex:1"><b>${u.n}</b> (${u.r})</div>
                            <button onclick="prepEditUser('${d.id}','${u.n}','${u.p}','${u.r}')" style="border:none; background:none; color:var(--p); margin-right:10px"><i class="fas fa-edit"></i></button>
                            <button onclick="delDoc('users','${d.id}')" style="border:none; background:none; color:var(--a)"><i class="fas fa-trash"></i></button>
                        </div>`;
                    });
                    document.getElementById('list-user-db').innerHTML = html;
                });
            }
            // Listen Misi & Hadiah (Code existing...)
            onSnapshot(collection(db, "misi"), (snap) => { /* Render Misi Code... */ });
        }

        // USER LOGIC
        window.resetUserForm = () => {
            document.getElementById('u-id').value = "";
            document.getElementById('u-nama').value = "";
            document.getElementById('u-pass').value = "";
            document.getElementById('u-title-text').innerText = "Tambah User Baru";
            openM('modal-user-form');
        };

        window.prepEditUser = (id, n, p, r) => {
            document.getElementById('u-id').value = id;
            document.getElementById('u-nama').value = n;
            document.getElementById('u-pass').value = p;
            document.getElementById('u-role').value = r;
            document.getElementById('u-title-text').innerText = "Edit User";
            openM('modal-user-form');
        };

        document.getElementById('btn-save-user').onclick = async () => {
            const id = document.getElementById('u-id').value;
            const data = { n: document.getElementById('u-nama').value.toLowerCase(), p: document.getElementById('u-pass').value, r: document.getElementById('u-role').value };
            id ? await updateDoc(doc(db, "users", id), data) : await addDoc(collection(db, "users"), data);
            closeM('modal-user-form');
        };

        document.getElementById('btn-user-trigger').onclick = () => openM('modal-user-list');

        // LOGIN DENGAN DATABASE
        document.getElementById('form-login').onsubmit = async (e) => {
            e.preventDefault();
            const uIn = document.getElementById('user-in').value.toLowerCase();
            const pIn = document.getElementById('pass-in').value;
            
            const q = query(collection(db, "users"), where("n", "==", uIn), where("p", "==", pIn));
            const snap = await getDocs(q);
            
            if(!snap.empty) {
                const uData = snap.docs[0].data();
                sessionStorage.setItem('u_online', JSON.stringify({n: uData.n, r: uData.r}));
                location.reload();
            } else {
                // Fallback untuk login pertama kali jika DB kosong
                if(uIn === 'papa' && pIn === 'papa') {
                    sessionStorage.setItem('u_online', JSON.stringify({n: 'papa', r: 'admin'}));
                    location.reload();
                } else alert("User tidak ditemukan!");
            }
        };

        // ... Sisa fungsi CRUD Misi/Hadiah (Tetap sama) ...
        window.delDoc = async (col, id) => { if(confirm('Hapus?')) await deleteDoc(doc(db, col, id)); };
        document.getElementById('btn-logout-trigger').onclick = () => { sessionStorage.clear(); location.reload(); };
    </script>
</body>
</html>
